<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>ETHORION</title>
  <style>
    :root{
      --bg:#0f1115;
      --fg:#e9edf5;
      --muted:#a8b0bd;

      --panel:#141823;
      --panel2:#101421;

      --line:rgba(255,255,255,0.10);
      --soft:rgba(255,255,255,0.06);

      --chip:rgba(0,0,0,0.18);

      --accent1:#f2f2f2;
      --accent2:#aeb7c7;

      --shadow:0 18px 60px rgba(0,0,0,0.58);
      --r:22px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: var(--bg);
      color: var(--fg);
      overflow-x:hidden;
    }

    /* ====== App Shell ====== */
    .shell{
      min-height:100vh;
      display:grid;
      grid-template-rows: auto 1fr auto;
    }

    /* Top minimal bar */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 12px 14px;
      gap:10px;
    }

    .topbar .left, .topbar .right{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }

    .iconbtn{
      border:1px solid var(--line);
      background: transparent;
      color: var(--fg);
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight: 900;
      letter-spacing:0.06em;
      text-transform: uppercase;
      font-size: 12px;
    }
    .iconbtn:hover{ border-color: rgba(242,242,242,0.22); }
    .iconbtn:active{ transform: translateY(1px); }
    .iconbtn:disabled{ opacity:0.5; cursor:not-allowed; }

    /* Chips */
    .chips{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .chip{
      display:inline-flex;
      gap:6px;
      align-items:center;
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: var(--chip);
      color: var(--muted);
      font-size: 12px;
      font-weight: 900;
      user-select:none;
      white-space:nowrap;
    }
    .chip b{ color: var(--fg); font-weight: 1000; }

    /* ====== Focus Center ====== */
    .stage{
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 10px 14px 18px;
    }

    .focusCard{
      width: min(900px, 96vw);
      border-radius: var(--r);
      border: 1px solid rgba(242,242,242,0.10);
      background:
        radial-gradient(900px 420px at 50% 0%, rgba(242,242,242,0.16), transparent 62%),
        linear-gradient(180deg, var(--panel), var(--panel2));
      box-shadow: var(--shadow);
      padding: 18px;
      display:grid;
      gap: 14px;
    }

    .brand{
      text-align:center;
      display:grid;
      gap: 6px;
      margin-top: 2px;
    }
    .brand h1{
      margin:0;
      font-size: clamp(28px, 4.8vw, 44px);
      font-weight: 1000;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      line-height:1;
    }
    .brand p{
      margin:0;
      color: var(--muted);
      font-size: 12px;
      letter-spacing:0.12em;
      text-transform: uppercase;
    }

    /* Big global bar (full -> decreases) */
    .barWrap{
      border-radius: 999px;
      height: 30px;
      background: rgba(255,255,255,0.06);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,0.10);
      position:relative;
    }
    .barFill{
      height:100%;
      width:100%;
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      transition: width 220ms ease;
    }
    .barLabel{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 12px;
      font-weight: 1000;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: rgba(10,12,16,0.92);
      mix-blend-mode: screen;
      user-select:none;
    }

    /* Focus task area */
    .target{
      display:grid;
      gap: 10px;
      text-align:center;
      align-items:center;
    }
    .targetTitle{
      font-size: clamp(18px, 3.2vw, 26px);
      font-weight: 980;
      line-height:1.15;
      word-break: break-word;
      padding: 0 6px;
    }
    .targetMeta{
      color: var(--muted);
      font-size: 12px;
      letter-spacing:0.04em;
      line-height:1.2;
    }

    /* Small task bar */
    .sbarWrap{
      border-radius: 999px;
      height: 14px;
      background: rgba(255,255,255,0.06);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,0.10);
      position:relative;
    }
    .sbarFill{
      height:100%;
      width:100%;
      background: linear-gradient(90deg, rgba(242,242,242,0.85), rgba(174,183,199,0.70));
      transition: width 180ms ease;
    }
    .sbarLabel{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 11px;
      font-weight: 1000;
      color: rgba(10,12,16,0.90);
      mix-blend-mode: screen;
      user-select:none;
    }

    /* Buttons */
    .actions{
      display:flex;
      justify-content:center;
      align-items:center;
      gap: 14px;
      flex-wrap:wrap;
      margin-top: 2px;
    }

    .btnRoulette{
      width: 86px;
      height: 86px;
      border-radius: 999px;
      border:1px solid rgba(242,242,242,0.20);
      background:
        radial-gradient(closest-side, rgba(242,242,242,0.20), rgba(0,0,0,0.05)),
        linear-gradient(180deg, #0b0d12, #0a0c10);
      color: var(--fg);
      cursor:pointer;
      font-weight: 1000;
      letter-spacing:0.10em;
      text-transform: uppercase;
      display:grid;
      place-items:center;
      user-select:none;
      position:relative;
      box-shadow: 0 12px 30px rgba(0,0,0,0.45);
    }
    .btnRoulette .ring{
      position:absolute; inset:10px;
      border-radius: 999px;
      border:1px dashed rgba(255,255,255,0.18);
      opacity:0.72;
    }
    .btnRoulette:hover{ border-color: rgba(242,242,242,0.36); }
    .btnRoulette:active{ transform: translateY(1px); }
    .btnRoulette:disabled{ opacity:0.5; cursor:not-allowed; }

    .btnRoulette.spinning .ring{ animation: spin 600ms linear infinite; }
    @keyframes spin{ from{ transform: rotate(0deg);} to{ transform: rotate(360deg);} }

    .btnDego{
      border:1px solid rgba(242,242,242,0.16);
      background:
        radial-gradient(900px 260px at 30% 20%, rgba(242,242,242,0.14), transparent 60%),
        linear-gradient(180deg, #0b0d12, #0a0c10);
      color:var(--fg);
      border-radius: 18px;
      padding: 14px 18px;
      cursor:pointer;
      font-weight: 1000;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      min-height: 58px;
      min-width: min(520px, 80vw);
    }
    .btnDego:hover{ border-color: rgba(242,242,242,0.30); }
    .btnDego:active{ transform: translateY(1px); }
    .btnDego:disabled{ opacity:0.5; cursor:not-allowed; }

    .subActions{
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
    }

    /* Footer hint */
    .hint{
      text-align:center;
      color: var(--muted);
      font-size: 12px;
      line-height:1.25;
      padding: 10px 14px 18px;
      opacity:0.95;
    }

    /* ====== Drawer (single menu for everything) ====== */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,0.56);
      opacity:0;
      pointer-events:none;
      transition: opacity 160ms ease;
      z-index: 90;
    }
    .overlay.show{ opacity:1; pointer-events:auto; }

    .drawer{
      position:fixed;
      top:0; left:0;
      height:100vh;
      width: min(560px, 92vw);
      background:
        radial-gradient(900px 420px at 40% 0%, rgba(242,242,242,0.14), transparent 62%),
        linear-gradient(180deg, var(--panel), var(--panel2));
      border-right: 1px solid rgba(255,255,255,0.10);
      transform: translateX(-110%);
      transition: transform 180ms ease;
      z-index: 100;
      display:grid;
      grid-template-rows: auto auto 1fr auto;
      gap: 12px;
      padding: 14px;
      box-shadow: var(--shadow);
    }
    .drawer.show{ transform: translateX(0); }

    .drawerHeader{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .drawerHeader .h{
      font-weight: 1000;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      font-size: 12px;
      color: var(--muted);
    }

    .tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .tab{
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.14);
      color: var(--fg);
      border-radius: 999px;
      padding: 8px 10px;
      cursor:pointer;
      font-weight: 950;
      font-size: 12px;
      letter-spacing:0.08em;
      text-transform: uppercase;
    }
    .tab.active{ border-color: rgba(242,242,242,0.24); }
    .tab:active{ transform: translateY(1px); }

    .drawerBody{
      overflow:auto;
      padding-right: 4px;
      display:grid;
      gap: 12px;
      align-content:start;
    }

    .card{
      border:1px solid rgba(255,255,255,0.08);
      border-radius: 18px;
      background: rgba(0,0,0,0.10);
      padding: 12px;
      display:grid;
      gap:10px;
    }
    .cardTitle{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      color: var(--muted);
      font-weight: 1000;
      letter-spacing:0.14em;
      text-transform: uppercase;
      font-size: 11px;
    }

    textarea, select, input[type="text"]{
      font:inherit;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
      color: var(--fg);
      border-radius: 14px;
      padding: 10px 12px;
      outline:none;
      font-size:13px;
    }
    textarea{ width:100%; min-height: 140px; resize: vertical; line-height:1.35; }
    textarea:focus, select:focus, input:focus{ border-color: rgba(242,242,242,0.22); }

    .rowBtns{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .btn{
      border:1px solid rgba(255,255,255,0.10);
      background: transparent;
      color: var(--fg);
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight: 950;
      font-size: 12px;
      letter-spacing:0.08em;
      text-transform: uppercase;
      white-space:nowrap;
    }
    .btn:hover{ border-color: rgba(242,242,242,0.18); }
    .btn:active{ transform: translateY(1px); }

    /* Lists */
    .list{ display:grid; gap:8px; }

    .trow{
      border:1px solid rgba(255,255,255,0.06);
      border-radius: 16px;
      background: rgba(0,0,0,0.12);
      padding: 10px;
      display:grid;
      gap:8px;
    }

    .trowTop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .tname{
      font-weight: 950;
      font-size: 14px;
      line-height:1.2;
      word-break: break-word;
    }
    .tmini{
      color: var(--muted);
      font-size: 12px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      line-height:1.15;
    }
    .tacts{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }
    .done{ text-decoration: line-through; opacity:0.55; }

    .sbarMiniWrap{
      border-radius: 999px;
      height: 12px;
      background: rgba(255,255,255,0.06);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,0.10);
      position:relative;
    }
    .sbarMiniFill{
      height:100%;
      background: linear-gradient(90deg, rgba(242,242,242,0.78), rgba(174,183,199,0.62));
      transition: width 180ms ease;
    }

    details{
      border:1px solid rgba(255,255,255,0.08);
      border-radius: 18px;
      overflow:hidden;
      background: rgba(0,0,0,0.10);
    }
    summary{
      cursor:pointer;
      padding: 10px 12px;
      color: var(--muted);
      font-weight: 1000;
      letter-spacing:0.14em;
      text-transform: uppercase;
      font-size: 11px;
      user-select:none;
    }
    details > .inside{
      padding: 10px 12px 12px;
      display:grid;
      gap:10px;
    }

    /* Toast + FX */
    .toast{
      position:fixed;
      left:50%;
      bottom: 14px;
      transform: translateX(-50%);
      background: rgba(11,13,18,0.92);
      border:1px solid rgba(255,255,255,0.10);
      border-radius: 14px;
      padding: 12px 14px;
      color: var(--fg);
      font-size: 13px;
      opacity:0;
      pointer-events:none;
      transition: opacity 160ms ease, transform 160ms ease;
      max-width: min(900px, calc(100vw - 24px));
      box-shadow: var(--shadow);
      white-space:pre-wrap;
      z-index: 120;
      backdrop-filter: blur(10px);
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(-6px);
    }

    canvas#fx{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index: 110;
    }

    /* Responsive tweaks */
    @media (max-width: 520px){
      .btnDego{ min-width: 92vw; }
      .focusCard{ padding: 16px; }
    }
  </style>
</head>

<body>
  <canvas id="fx"></canvas>

  <div class="shell">
    <div class="topbar">
      <div class="left">
        <button class="iconbtn" id="btnMenu" aria-label="Menu">☰</button>
        <button class="iconbtn" id="btnNewDay">Nouveau jour</button>
      </div>

      <div class="right chips" aria-label="Compteurs">
        <span class="chip">Départ <b id="startTasks">0</b> tâches</span>
        <span class="chip">Reste <b id="leftTasks">0</b> tâches</span>
        <span class="chip">ETHORION <b id="leftEth">0</b>/<b id="startEth">0</b></span>
        <span class="chip">Éliminé <b id="elimEth">0</b></span>
      </div>
    </div>

    <div class="stage">
      <section class="focusCard" aria-label="Focus">
        <div class="brand">
          <h1>ETHORION</h1>
          <p>Dégommer les tous</p>
        </div>

        <!-- BIG GLOBAL BAR (remaining %) -->
        <div class="barWrap" aria-label="Progression globale">
          <div class="barFill" id="gFill"></div>
          <div class="barLabel" id="gLabel">100%</div>
        </div>

        <div class="target" aria-label="Cible">
          <div class="targetTitle" id="focusTitle">CIBLE EN COURS DE RECHERCHE</div>
          <div class="targetMeta" id="focusMeta">—</div>

          <div class="chips" style="justify-content:center;">
            <span class="chip">ETHORION <b id="focusEth">0</b></span>
            <span class="chip">Priorité <b id="focusPrio">—</b></span>
            <span class="chip">Énergie <b id="focusEnergy">—</b></span>
          </div>

          <!-- SMALL TASK BAR -->
          <div class="sbarWrap" aria-label="Progression tâche">
            <div class="sbarFill" id="tFill"></div>
            <div class="sbarLabel" id="tLabel">100%</div>
          </div>

          <div class="actions">
            <button class="btnRoulette" id="btnRoulette" aria-label="Roulette">
              <span class="ring"></span>
              R
            </button>
            <button class="btnDego" id="btnDego">Dégommer 1 ETHORION</button>
          </div>

          <div class="subActions">
            <button class="btn" id="btnNotes">Notes</button>
            <button class="btn" id="btnDone">Terminer</button>
            <button class="btn" id="btnSkip">Passer</button>
          </div>
        </div>
      </section>
    </div>

    <div class="hint">
      Import : seules les lignes qui commencent par “-” sont ajoutées comme tâches. Le reste = catégories.
      Raccourci : Ctrl/⌘+Enter pour ajouter depuis Inbox.
    </div>
  </div>

  <!-- Drawer -->
  <div class="overlay" id="overlay"></div>
  <aside class="drawer" id="drawer" aria-label="Menu latéral">
    <div class="drawerHeader">
      <div class="h">Menu</div>
      <button class="btn" id="btnClose">Fermer</button>
    </div>

    <div class="tabs" id="tabs"></div>
    <div class="drawerBody" id="drawerBody"></div>

    <div class="rowBtns">
      <button class="btn" id="btnUndo">Undo</button>
      <button class="btn" id="btnRedo">Redo</button>
    </div>
  </aside>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
(() => {
  "use strict";

  // =========================
  // Storage + State
  // =========================
  const LS_KEY = "ethorion_app_v1";
  const MAX_HISTORY = 40;

  const el = (id)=>document.getElementById(id);

  // Top counters
  const startTasksEl = el("startTasks");
  const leftTasksEl  = el("leftTasks");
  const startEthEl   = el("startEth");
  const leftEthEl    = el("leftEth");
  const elimEthEl    = el("elimEth");

  // Bars
  const gFill = el("gFill");
  const gLabel = el("gLabel");
  const tFill = el("tFill");
  const tLabel = el("tLabel");

  // Focus
  const focusTitle = el("focusTitle");
  const focusMeta = el("focusMeta");
  const focusEth = el("focusEth");
  const focusPrio = el("focusPrio");
  const focusEnergy = el("focusEnergy");

  // Buttons
  const btnMenu = el("btnMenu");
  const btnNewDay = el("btnNewDay");
  const btnRoulette = el("btnRoulette");
  const btnDego = el("btnDego");
  const btnNotes = el("btnNotes");
  const btnDone = el("btnDone");
  const btnSkip = el("btnSkip");

  // Drawer
  const overlay = el("overlay");
  const drawer = el("drawer");
  const btnClose = el("btnClose");
  const tabs = el("tabs");
  const drawerBody = el("drawerBody");
  const btnUndo = el("btnUndo");
  const btnRedo = el("btnRedo");

  // Toast + FX
  const toast = el("toast");
  const fxCanvas = el("fx");
  const fx = fxCanvas.getContext("2d");

  const now = ()=>Date.now();
  const clamp = (n,a,b)=>Math.max(a, Math.min(b,n));
  const uid = ()=> Math.random().toString(36).slice(2,10)+"-"+Date.now().toString(36);

  // =========================
  // Default State
  // =========================
  function isoDay(d = new Date()){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const da = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
  }

  function initial(){
    const today = isoDay();
    return {
      version: 1,
      day: {
        id: today,
        startTasks: 0,
        startEth: 0
      },
      focusId: null,
      energyProfile: { level: 2, motivation: 2 }, // 1..3
      ui: { activeTab: "inbox", sort: "order" },
      tasks: [],
      sets: [
        {
          id: "set_consult",
          name: "Consult",
          lines: [
            "PATIENTS",
            "- Patient 1 – 2 ethorions – importance 3",
            "- Patient 2 – 2 ethorions – importance 3",
            "- Patient 3 – 2 ethorions – importance 3",
            "- Patient 4 – 2 ethorions – importance 3",
            "ENCODAGE",
            "- Encoder la note Patient 1 – 1 ethorion – importance 2",
            "- Encoder la note Patient 2 – 1 ethorion – importance 2",
            "- Encoder la note Patient 3 – 1 ethorion – importance 2",
            "- Encoder la note Patient 4 – 1 ethorion – importance 2"
          ]
        },
        {
          id: "set_appels",
          name: "Appels",
          lines: [
            "APPELS",
            "- Appeler X – 1 ethorion – importance 2",
            "- Appeler Y – 1 ethorion – importance 2"
          ]
        }
      ],
      history: { undo: [], redo: [] },
      events: [] // visible history log
    };
  }

  let state = load() || initial();

  function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

  function load(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return null;
      const obj = JSON.parse(raw);
      if(!obj || !Array.isArray(obj.tasks)) return null;
      // basic migrations
      if(!obj.sets) obj.sets = initial().sets;
      if(!obj.history) obj.history = {undo:[], redo:[]};
      if(!obj.events) obj.events = [];
      if(!obj.energyProfile) obj.energyProfile = {level:2, motivation:2};
      if(!obj.ui) obj.ui = {activeTab:"inbox", sort:"order"};
      if(!obj.day) obj.day = initial().day;
      return obj;
    }catch{ return null; }
  }

  // =========================
  // History (undo/redo) + visible log
  // =========================
  function snapshot(){
    const s = structuredClone({...state});
    s.history = {undo:[], redo:[]};
    return s;
  }

  function logEvent(text){
    state.events.push({ t: now(), text: String(text).slice(0,220) });
    state.events = state.events.slice(-200);
  }

  function pushHistory(label){
    state.history.undo.push(snapshot());
    if(state.history.undo.length > MAX_HISTORY) state.history.undo.shift();
    state.history.redo = [];
    if(label) logEvent(label);
    save();
    updateUndoRedo();
  }

  function undo(){
    if(!state.history.undo.length) return;
    const prev = state.history.undo.pop();
    const cur = snapshot();
    state.history.redo.push(cur);
    const keep = state.history;
    state = {...prev, history: keep};
    save();
    renderAll();
  }

  function redo(){
    if(!state.history.redo.length) return;
    const next = state.history.redo.pop();
    const cur = snapshot();
    state.history.undo.push(cur);
    const keep = state.history;
    state = {...next, history: keep};
    save();
    renderAll();
  }

  function updateUndoRedo(){
    btnUndo.disabled = state.history.undo.length===0;
    btnRedo.disabled = state.history.redo.length===0;
  }

  // =========================
  // Parsing
  // =========================
  function cleanLine(s){
    let x = String(s||"").trim();
    x = x.replace(/[|¦]+/g," ").replace(/\s{2,}/g," ").trim();
    return x;
  }

  function isTaskLine(line){
    return /^-\s+/.test(line);
  }

  function stripTaskPrefix(line){
    return line.replace(/^-+\s*/, "").trim();
  }

  function parseEthorion(text){
    const t = text.toLowerCase();
    const m = t.match(/(\d{1,2})\s*(?:ethorion|ethorions|eth)\b/);
    if(m) return clamp(parseInt(m[1],10)||1, 1, 50);
    return null;
  }

  function parseMinutes(text){
    const t = text.toLowerCase();
    const m = t.match(/(\d{1,3})\s*(?:minutes|minute|min)\b/);
    if(m) return clamp(parseInt(m[1],10)||0, 1, 999);
    return null;
  }

  function parseImportance(text){
    const t = text.toLowerCase();
    const m = t.match(/\b(?:importance|prio|priorité)\s*(\d)\b/);
    if(m) return clamp(parseInt(m[1],10)||2, 1, 3);
    return null;
  }

  function removeMetaFromTitle(raw){
    // normalize dashes and keep first segment as title
    let x = raw.replace(/\s*[—–]\s*/g, " – ");
    const parts = x.split(" – ").map(p=>p.trim()).filter(Boolean);
    return (parts[0] || raw).trim();
  }

  function inferEnergyFromText(title, category){
    const t = (title+" "+(category||"")).toLowerCase();
    if(/\b(appeler|tél|tel|téléphone|mail|email|encoder|encodage|note)\b/.test(t)) return 1;
    if(/\b(rapport|rédaction|dossier|analyse)\b/.test(t)) return 3;
    return 2;
  }

  function parsePasted(raw){
    const lines = String(raw||"").split(/\r?\n/).map(cleanLine);
    let currentCategory = "Sans catégorie";
    const out = [];

    for(const line0 of lines){
      const line = line0.trim();
      if(!line) continue;

      if(!isTaskLine(line)){
        currentCategory = line.replace(/:+$/,"").trim() || currentCategory;
        continue;
      }

      const body = stripTaskPrefix(line);

      const eth = parseEthorion(body) ?? 3;
      const minutes = parseMinutes(body);
      const prio = parseImportance(body) ?? 2;

      const title = cleanLine(removeMetaFromTitle(body));
      out.push({
        title,
        category: currentCategory,
        ethorionTotal: eth,
        ethorionRemaining: eth,
        minutesHint: minutes || null,
        priority: prio,
        energyTag: inferEnergyFromText(title, currentCategory)
      });
    }
    return out;
  }

  // =========================
  // Day baseline
  // =========================
  function ensureDay(){
    const today = isoDay();
    if(state.day.id !== today){
      state.day.id = today;
      state.day.startTasks = 0;
      state.day.startEth = 0;
    }
    if(state.day.startTasks===0 && state.day.startEth===0){
      setDayBaseline("Départ fixé");
    }
  }

  function setDayBaseline(label){
    const active = state.tasks.filter(t=>!t.done);
    state.day.startTasks = active.length;
    state.day.startEth = active.reduce((a,t)=>a + (t.ethorionRemaining||0), 0);
    logEvent(label || "Départ fixé");
    save();
  }

  function newDay(){
    pushHistory("Nouveau jour");
    setDayBaseline("Nouveau jour");
    renderAll();
    showToast("Nouveau jour.", 2400);
  }

  // =========================
  // Tasks
  // =========================
  function nextOrder(){
    const act = state.tasks.filter(t=>!t.done);
    if(!act.length) return 1;
    return Math.max(...act.map(t=>t.order||0)) + 1;
  }

  function addTasksFromText(raw){
    const parsed = parsePasted(raw);
    if(!parsed.length){
      showToast("Rien (vérifie les tirets).", 2600);
      return;
    }
    pushHistory(`Ajout ${parsed.length} tâche(s)`);

    const start = nextOrder();
    parsed.forEach((p,i)=>{
      state.tasks.push({
        id: uid(),
        title: p.title,
        category: p.category,
        ethorionTotal: p.ethorionTotal,
        ethorionRemaining: p.ethorionRemaining,
        minutesHint: p.minutesHint,
        priority: p.priority,
        energyTag: p.energyTag,
        notes: "",
        done: false,
        order: start+i,
        createdAt: now(),
        doneAt: null
      });
    });

    ensureDay();
    if(!state.focusId){
      const t = pickWeightedTask();
      if(t) state.focusId = t.id;
    }

    save();
    renderAll();
    showToast("Ajouté.", 2400);
  }

  function getTask(id){ return state.tasks.find(t=>t.id===id) || null; }

  function setFocus(id){
    state.focusId = id;
    save();
    renderFocus();
  }

  function finishTask(taskId, opts={}){
    const t = getTask(taskId);
    if(!t) return;

    if(!opts.silent) pushHistory("Terminer tâche");

    t.done = true;
    t.doneAt = now();
    t.ethorionRemaining = 0;

    confetti(2.2);
    flash();
    showToast(pick(DONE_LINES), 3400);

    const next = pickWeightedTask();
    state.focusId = next ? next.id : null;

    save();
    renderAll();
  }

  function degoOne(){
    const t = getTask(state.focusId);
    if(!t){
      showToast("CIBLE INDISPONIBLE.", 2400);
      return;
    }

    pushHistory("Dégommage");
    t.ethorionRemaining = Math.max(0, (t.ethorionRemaining||0) - 1);

    confetti(1.0);
    flash();
    showToast(pick(LINES), 2600);

    if(t.ethorionRemaining===0){
      finishTask(t.id, {silent:true});
      return;
    }

    save();
    renderAll();
  }

  function skip(){
    const next = pickWeightedTask();
    state.focusId = next ? next.id : null;
    save();
    renderAll();
    showToast(next ? "CIBLE CHANGÉE." : "PLUS DE CIBLES.", 2400);
  }

  function deleteTask(taskId){
    if(!confirm("Supprimer ?")) return;
    pushHistory("Supprimer tâche");
    if(state.focusId === taskId) state.focusId = null;
    state.tasks = state.tasks.filter(x=>x.id!==taskId);
    save();
    renderAll();
  }

  function duplicateTask(taskId){
    const t = getTask(taskId);
    if(!t) return;
    pushHistory("Dupliquer tâche");
    const c = structuredClone(t);
    c.id = uid();
    c.done = false;
    c.doneAt = null;
    c.ethorionRemaining = c.ethorionTotal;
    c.order = nextOrder();
    c.createdAt = now();
    state.tasks.push(c);
    save();
    renderAll();
    showToast("Dupliqué.", 2200);
  }

  function setEthorion(taskId){
    const t = getTask(taskId);
    if(!t || t.done) return;
    const val = prompt("ETHORION total ?", String(t.ethorionTotal||3));
    if(val===null) return;

    pushHistory("Régler ethorion");
    const n = clamp(parseInt(val,10)||t.ethorionTotal||3, 1, 50);

    const wasTotal = Math.max(1, t.ethorionTotal||1);
    const wasRem = clamp(t.ethorionRemaining||0, 0, wasTotal);
    const ratio = wasTotal ? (wasRem/wasTotal) : 1;

    t.ethorionTotal = n;
    t.ethorionRemaining = clamp(Math.round(n*ratio), 0, n);
    if(t.ethorionRemaining===0) t.ethorionRemaining = Math.min(1,n);

    save();
    renderAll();
    showToast("OK", 1800);
  }

  // =========================
  // Weighted roulette with energy/motivation
  // =========================
  function pickWeightedTask(){
    const pool = state.tasks.filter(t=>!t.done && (t.ethorionRemaining||0) > 0);
    if(!pool.length) return null;

    const E = state.energyProfile.level;      // 1..3
    const M = state.energyProfile.motivation; // 1..3

    const weights = pool.map(t=>{
      const rem = Math.max(1, Math.ceil(t.ethorionRemaining||1));
      const pr = (t.priority===3? 3 : t.priority===2? 2 : 1);

      let fit = 1.0;
      if(E===1){
        fit *= (t.energyTag===1 ? 1.45 : t.energyTag===2 ? 0.95 : 0.55);
      }else if(E===2){
        fit *= (t.energyTag===1 ? 1.10 : t.energyTag===2 ? 1.25 : 0.95);
      }else{
        fit *= (t.energyTag===3 ? 1.30 : 1.05);
      }

      let mot = 1.0;
      if(M===1){
        mot *= (rem<=2 ? 1.45 : rem<=4 ? 1.05 : 0.70);
      }else if(M===2){
        mot *= (rem<=3 ? 1.15 : 1.0);
      }else{
        mot *= 1.0;
      }

      return Math.max(0.2, rem * pr * fit * mot);
    });

    const total = weights.reduce((a,b)=>a+b,0);
    let r = Math.random()*total;
    for(let i=0;i<pool.length;i++){
      r -= weights[i];
      if(r<=0) return pool[i];
    }
    return pool[pool.length-1];
  }

  // Roulette suspense
  let rouletteLock = false;
  function roulette(){
    if(rouletteLock) return;
    rouletteLock = true;
    btnRoulette.disabled = true;
    btnRoulette.classList.add("spinning");

    showToast("scan…", 1100);
    const suspense = 650 + Math.floor(Math.random()*260);

    setTimeout(()=>{
      const t = pickWeightedTask();
      if(t){
        state.focusId = t.id;
        showToast("CIBLE VERROUILLÉE.", 2400);
        confetti(1.2);
        flash();
      }else{
        state.focusId = null;
        showToast("PLUS DE CIBLES.", 2400);
      }

      btnRoulette.disabled = false;
      btnRoulette.classList.remove("spinning");
      rouletteLock = false;

      save();
      renderAll();
    }, suspense);
  }

  // =========================
  // Sorting + drag reorder (Liste)
  // =========================
  function getActiveSorted(){
    const items = state.tasks.filter(t=>!t.done);
    const sort = state.ui.sort || "order";
    if(sort==="prio"){
      items.sort((a,b)=>(b.priority||2)-(a.priority||2) || (a.order||0)-(b.order||0));
    }else if(sort==="eth"){
      items.sort((a,b)=>(b.ethorionRemaining||0)-(a.ethorionRemaining||0) || (b.priority||2)-(a.priority||2));
    }else if(sort==="cat"){
      items.sort((a,b)=> (a.category||"").localeCompare(b.category||"", "fr") || (a.order||0)-(b.order||0));
    }else{
      items.sort((a,b)=>(a.order||0)-(b.order||0));
    }
    return items;
  }

  function applyOrderFromList(ids){
    // set order sequentially
    let k = 1;
    ids.forEach(id=>{
      const t = getTask(id);
      if(t && !t.done) t.order = k++;
    });
  }

  // =========================
  // Rendering
  // =========================
  function sumActiveEth(){
    return state.tasks.reduce((a,t)=>a + (t.done?0:(t.ethorionRemaining||0)), 0);
  }
  function countActiveTasks(){
    return state.tasks.filter(t=>!t.done).length;
  }

  function renderCounters(){
    ensureDay();

    const leftTasks = countActiveTasks();
    const leftEth = sumActiveEth();

    const startT = state.day.startTasks || leftTasks;
    const startE = state.day.startEth || leftEth;

    const elimEth = Math.max(0, startE - leftEth);

    startTasksEl.textContent = String(startT);
    leftTasksEl.textContent  = String(leftTasks);
    startEthEl.textContent   = String(startE);
    leftEthEl.textContent    = String(leftEth);
    elimEthEl.textContent    = String(elimEth);

    const denom = Math.max(1, startE);
    const pctLeft = clamp(Math.round((leftEth/denom)*100), 0, 100);
    gFill.style.width = `${pctLeft}%`;
    gLabel.textContent = `${pctLeft}%`;

    updateUndoRedo();
  }

  function renderFocus(){
    const t = getTask(state.focusId);
    if(!t){
      focusTitle.textContent = "CIBLE EN COURS DE RECHERCHE";
      focusMeta.textContent = "—";
      focusEth.textContent = "0";
      focusPrio.textContent = "—";
      focusEnergy.textContent = "—";

      tFill.style.width = "100%";
      tLabel.textContent = "100%";

      btnDego.disabled = true;
      btnNotes.disabled = true;
      btnDone.disabled = true;
      btnSkip.disabled = false;
      return;
    }

    focusTitle.textContent = t.title;
    const hintMin = t.minutesHint ? ` · ${t.minutesHint} min` : "";
    focusMeta.textContent = `${t.category} · P${t.priority}${hintMin}`;

    focusEth.textContent = `${t.ethorionRemaining}/${t.ethorionTotal}`;
    focusPrio.textContent = String(t.priority);
    focusEnergy.textContent = (t.energyTag===1 ? "basse" : t.energyTag===2 ? "moyenne" : "haute");

    const total = Math.max(1, t.ethorionTotal||1);
    const rem = clamp(t.ethorionRemaining||0, 0, total);
    const pctLeft = clamp(Math.round((rem/total)*100), 0, 100);
    tFill.style.width = `${pctLeft}%`;
    tLabel.textContent = `${pctLeft}%`;

    btnDego.disabled = false;
    btnNotes.disabled = false;
    btnDone.disabled = false;
  }

  function renderAll(){
    renderCounters();
    renderFocus();
    renderDrawer(); // keep drawer content coherent with updates
  }

  // =========================
  // Drawer Tabs + Content
  // =========================
  const TAB_DEFS = [
    { key:"inbox",   label:"Inbox" },
    { key:"liste",   label:"Liste" },
    { key:"cats",    label:"Cat" },
    { key:"sets",    label:"Sets" },
    { key:"energie", label:"Énergie" },
    { key:"hist",    label:"Hist" },
    { key:"rapport", label:"Rapport" }
  ];

  function setTab(key){
    state.ui.activeTab = key;
    save();
    renderDrawer();
  }

  function renderTabs(){
    tabs.innerHTML = "";
    TAB_DEFS.forEach(t=>{
      const b = document.createElement("button");
      b.className = "tab" + (state.ui.activeTab===t.key ? " active" : "");
      b.textContent = t.label;
      b.addEventListener("click", ()=> setTab(t.key));
      tabs.appendChild(b);
    });
  }

  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[c]));
  }

  function miniBarPct(rem, total){
    total = Math.max(1, total||1);
    rem = clamp(rem||0, 0, total);
    return clamp(Math.round((rem/total)*100), 0, 100);
  }

  function renderTaskRow(t, {draggable=false}={}){
    const row = document.createElement("div");
    row.className = "trow";
    row.dataset.id = t.id;

    const pct = miniBarPct(t.ethorionRemaining, t.ethorionTotal);

    row.innerHTML = `
      <div class="trowTop">
        <div style="min-width:0;">
          <div class="tname ${t.done ? "done":""}">${esc(t.title)}</div>
          <div class="tmini">
            <span>${esc(t.category)}</span>
            <span>·</span>
            <span>P${esc(String(t.priority))}</span>
            <span>·</span>
            <span>ETH ${esc(String(t.ethorionRemaining))}/${esc(String(t.ethorionTotal))}</span>
          </div>
        </div>
        <div class="tacts">
          ${!t.done ? `<button class="btn" data-a="focus">Focus</button>` : ""}
          ${!t.done ? `<button class="btn" data-a="eth">Eth</button>` : ""}
          ${!t.done ? `<button class="btn" data-a="dup">Dupl</button>` : ""}
          ${!t.done ? `<button class="btn" data-a="ok">OK</button>` : ""}
          <button class="btn" data-a="x">X</button>
        </div>
      </div>
      <div class="sbarMiniWrap" aria-label="Progression">
        <div class="sbarMiniFill" style="width:${pct}%"></div>
      </div>
    `;

    row.querySelectorAll("[data-a]").forEach(btn=>{
      const a = btn.dataset.a;
      btn.addEventListener("click", ()=>{
        if(a==="focus"){ setFocus(t.id); renderAll(); }
        if(a==="eth"){ setEthorion(t.id); }
        if(a==="dup"){ duplicateTask(t.id); }
        if(a==="ok"){ finishTask(t.id); }
        if(a==="x"){ deleteTask(t.id); }
      });
    });

    if(draggable && !t.done){
      row.draggable = true;
      row.style.cursor = "grab";
    }

    return row;
  }

  function renderDrawerInbox(){
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="cardTitle"><span>Inbox</span><span>Ctrl/⌘+Enter</span></div>
      <textarea id="inboxTA" placeholder="Catégorie
- Tâche – 3 ethorions – 15 minutes – importance 2
- …"></textarea>
      <div class="rowBtns">
        <button class="btn" id="btnAdd">Ajouter</button>
        <button class="btn" id="btnApplyConsult">Appliquer set Consult</button>
      </div>
    `;
    const ta = card.querySelector("#inboxTA");
    const add = card.querySelector("#btnAdd");
    const applyConsult = card.querySelector("#btnApplyConsult");

    add.addEventListener("click", ()=>{
      addTasksFromText(ta.value);
      ta.value = "";
    });

    applyConsult.addEventListener("click", ()=>{
      const s = state.sets.find(x=>x.name.toLowerCase()==="consult") || state.sets[0];
      if(s) addTasksFromText((s.lines||[]).join("\n"));
    });

    // shortcut for inbox
    ta.addEventListener("keydown", (e)=>{
      if((e.ctrlKey||e.metaKey) && e.key==="Enter"){
        e.preventDefault();
        add.click();
      }
    });

    return card;
  }

  function renderDrawerList(){
    const wrap = document.createElement("div");
    wrap.className = "card";
    wrap.innerHTML = `
      <div class="cardTitle">
        <span>Liste</span>
        <span>
          <select id="sortSel" aria-label="Tri">
            <option value="order">Tri: ordre</option>
            <option value="prio">Tri: priorité</option>
            <option value="eth">Tri: ethorion</option>
            <option value="cat">Tri: catégorie</option>
          </select>
        </span>
      </div>
      <div class="list" id="taskList"></div>
      <details>
        <summary>Terminé</summary>
        <div class="inside">
          <div class="list" id="doneList"></div>
        </div>
      </details>
    `;

    const sortSel = wrap.querySelector("#sortSel");
    sortSel.value = state.ui.sort || "order";
    sortSel.addEventListener("change", ()=>{
      pushHistory("Tri");
      state.ui.sort = sortSel.value;
      save();
      renderDrawer();
    });

    const list = wrap.querySelector("#taskList");
    const items = getActiveSorted();

    // Drag reorder only when "ordre" sorting
    const draggable = (state.ui.sort==="order");

    items.forEach(t=> list.appendChild(renderTaskRow(t, {draggable})));

    // Drag-and-drop reorder
    if(draggable){
      let dragId = null;

      list.addEventListener("dragstart", (e)=>{
        const row = e.target.closest(".trow");
        if(!row) return;
        dragId = row.dataset.id;
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("text/plain", dragId);
      });

      list.addEventListener("dragover", (e)=>{
        e.preventDefault();
        e.dataTransfer.dropEffect = "move";
      });

      list.addEventListener("drop", (e)=>{
        e.preventDefault();
        const targetRow = e.target.closest(".trow");
        if(!targetRow) return;

        const fromId = e.dataTransfer.getData("text/plain") || dragId;
        const toId = targetRow.dataset.id;
        if(!fromId || !toId || fromId===toId) return;

        const rows = [...list.querySelectorAll(".trow")];
        const fromEl = rows.find(r=>r.dataset.id===fromId);
        const toEl = rows.find(r=>r.dataset.id===toId);
        if(!fromEl || !toEl) return;

        pushHistory("Réordonner");

        // insert
        const rect = toEl.getBoundingClientRect();
        const after = (e.clientY - rect.top) > rect.height/2;
        if(after) toEl.after(fromEl);
        else toEl.before(fromEl);

        // apply new order to tasks
        const ids = [...list.querySelectorAll(".trow")].map(r=>r.dataset.id);
        applyOrderFromList(ids);

        save();
        renderDrawer();
        showToast("Ordre mis à jour.", 2200);
      });
    }

    // Done list
    const doneList = wrap.querySelector("#doneList");
    state.tasks
      .filter(t=>t.done)
      .sort((a,b)=>(b.doneAt||0)-(a.doneAt||0))
      .slice(0, 40)
      .forEach(t=> doneList.appendChild(renderTaskRow(t)));

    return wrap;
  }

  function groupByCategory(tasks){
    const m = new Map();
    tasks.forEach(t=>{
      const k = t.category || "Sans catégorie";
      if(!m.has(k)) m.set(k, []);
      m.get(k).push(t);
    });
    const keys = [...m.keys()].sort((a,b)=>a.localeCompare(b, "fr"));
    return {m, keys};
  }

  function renderDrawerCats(){
    const wrap = document.createElement("div");
    wrap.className = "card";
    wrap.innerHTML = `<div class="cardTitle"><span>Catégories</span><span>clic pour ouvrir</span></div>`;

    const items = getActiveSorted();
    const {m, keys} = groupByCategory(items);

    keys.forEach(cat=>{
      const det = document.createElement("details");
      det.open = false;
      const sumEth = m.get(cat).reduce((a,t)=>a+(t.ethorionRemaining||0),0);
      const sum = document.createElement("summary");
      sum.textContent = `${cat} — ETH ${sumEth}`;
      det.appendChild(sum);

      const inside = document.createElement("div");
      inside.className = "inside";
      const list = document.createElement("div");
      list.className = "list";
      m.get(cat).forEach(t=> list.appendChild(renderTaskRow(t)));
      inside.appendChild(list);
      det.appendChild(inside);

      wrap.appendChild(det);
    });

    return wrap;
  }

  function renderDrawerSets(){
    const wrap = document.createElement("div");
    wrap.className = "card";
    wrap.innerHTML = `
      <div class="cardTitle"><span>Sets</span><span>préenregistrés + perso</span></div>
      <div class="list" id="setsList"></div>
      <div class="rowBtns">
        <button class="btn" id="btnNewSet">+ Set</button>
      </div>
    `;

    const list = wrap.querySelector("#setsList");

    state.sets.forEach(s=>{
      const row = document.createElement("div");
      row.className = "trow";
      row.innerHTML = `
        <div class="trowTop">
          <div>
            <div class="tname">${esc(s.name)}</div>
            <div class="tmini">${esc(String((s.lines||[]).length))} lignes</div>
          </div>
          <div class="tacts">
            <button class="btn" data-a="apply">Appliquer</button>
            <button class="btn" data-a="edit">Éditer</button>
            <button class="btn" data-a="del">X</button>
          </div>
        </div>
      `;

      row.querySelector('[data-a="apply"]').addEventListener("click", ()=>{
        addTasksFromText((s.lines||[]).join("\n"));
        showToast("Set appliqué.", 2400);
      });

      row.querySelector('[data-a="edit"]').addEventListener("click", ()=>{
        openSetEditor(s.id);
      });

      row.querySelector('[data-a="del"]').addEventListener("click", ()=>{
        if(!confirm("Supprimer set ?")) return;
        pushHistory("Supprimer set");
        state.sets = state.sets.filter(x=>x.id!==s.id);
        save();
        renderDrawer();
      });

      list.appendChild(row);
    });

    wrap.querySelector("#btnNewSet").addEventListener("click", ()=> openSetEditor(null));
    return wrap;
  }

  function openSetEditor(setId){
    const s = setId ? state.sets.find(x=>x.id===setId) : null;

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="cardTitle"><span>${s ? "Éditer set" : "Nouveau set"}</span><span>lignes avec tiret = tâches</span></div>
      <input type="text" id="setName" placeholder="Nom du set" value="${esc(s ? s.name : "")}">
      <textarea id="setLines" placeholder="Catégorie
- tâche
- tâche">${esc(s ? (s.lines||[]).join("\n") : "")}</textarea>
      <div class="rowBtns">
        <button class="btn" id="btnSaveSet">Enregistrer</button>
        <button class="btn" id="btnCancelSet">Annuler</button>
      </div>
    `;

    const name = card.querySelector("#setName");
    const lines = card.querySelector("#setLines");
    const saveBtn = card.querySelector("#btnSaveSet");
    const cancelBtn = card.querySelector("#btnCancelSet");

    saveBtn.addEventListener("click", ()=>{
      const n = cleanLine(name.value).slice(0,40);
      const ls = String(lines.value||"").split(/\r?\n/).map(cleanLine).filter(Boolean);
      if(!n){ showToast("Nom ?", 2200); return; }
      if(!ls.length){ showToast("Lignes ?", 2200); return; }

      pushHistory("Enregistrer set");

      if(s){
        s.name = n;
        s.lines = ls;
      }else{
        state.sets.push({ id:"set_"+uid(), name:n, lines: ls });
      }
      save();
      renderDrawer();
      showToast("OK", 2000);
    });

    cancelBtn.addEventListener("click", ()=> renderDrawer());
    drawerBody.innerHTML = "";
    drawerBody.appendChild(card);
  }

  function renderDrawerEnergy(){
    const wrap = document.createElement("div");
    wrap.className = "card";
    wrap.innerHTML = `
      <div class="cardTitle"><span>Énergie</span><span>influence roulette</span></div>
      <select id="lvl">
        <option value="1">Énergie: basse</option>
        <option value="2">Énergie: moyenne</option>
        <option value="3">Énergie: haute</option>
      </select>
      <select id="mot">
        <option value="1">Motivation: basse</option>
        <option value="2">Motivation: moyenne</option>
        <option value="3">Motivation: haute</option>
      </select>
      <div class="rowBtns">
        <button class="btn" id="btnApply">Appliquer</button>
      </div>
    `;

    const lvl = wrap.querySelector("#lvl");
    const mot = wrap.querySelector("#mot");
    lvl.value = String(state.energyProfile.level||2);
    mot.value = String(state.energyProfile.motivation||2);

    wrap.querySelector("#btnApply").addEventListener("click", ()=>{
      pushHistory("Énergie réglée");
      state.energyProfile.level = parseInt(lvl.value,10);
      state.energyProfile.motivation = parseInt(mot.value,10);
      save();
      renderAll();
      showToast("OK", 2200);
    });

    return wrap;
  }

  function renderDrawerHist(){
    const wrap = document.createElement("div");
    wrap.className = "card";
    wrap.innerHTML = `<div class="cardTitle"><span>Historique</span><span>visible</span></div>`;

    const list = document.createElement("div");
    list.className = "list";

    state.events.slice().reverse().slice(0, 120).forEach(ev=>{
      const row = document.createElement("div");
      row.className = "trow";
      const d = new Date(ev.t);
      const ts = `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
      row.innerHTML = `<div class="tmini"><b>${esc(ts)}</b> · ${esc(ev.text)}</div>`;
      list.appendChild(row);
    });

    wrap.appendChild(list);
    return wrap;
  }

  function renderDrawerRapport(){
    const wrap = document.createElement("div");
    wrap.className = "card";
    wrap.innerHTML = `<div class="cardTitle"><span>Rapport</span><span>jour</span></div>`;

    const active = state.tasks.filter(t=>!t.done);
    const done = state.tasks.filter(t=>t.done);

    const leftTasks = active.length;
    const leftEth = active.reduce((a,t)=>a+(t.ethorionRemaining||0),0);

    const startT = state.day.startTasks || 0;
    const startE = state.day.startEth || 0;
    const doneTasks = done.length;
    const elimEth = Math.max(0, startE - leftEth);

    const box = document.createElement("div");
    box.className = "trow";
    box.innerHTML = `
      <div class="tname">Aujourd’hui</div>
      <div class="tmini">Départ: ${esc(String(startT))} tâches · ${esc(String(startE))} ETH</div>
      <div class="tmini">Reste: ${esc(String(leftTasks))} tâches · ${esc(String(leftEth))} ETH</div>
      <div class="tmini">Éliminé: ${esc(String(elimEth))} ETH · Terminé: ${esc(String(doneTasks))} tâches</div>
    `;

    wrap.appendChild(box);

    // by category
    const byCat = {};
    state.tasks.forEach(t=>{
      const c = t.category || "Sans catégorie";
      if(!byCat[c]) byCat[c] = { n:0, total:0, left:0 };
      byCat[c].n++;
      byCat[c].total += (t.ethorionTotal||0);
      byCat[c].left += (t.done?0:(t.ethorionRemaining||0));
    });

    const list = document.createElement("div");
    list.className = "list";
    Object.keys(byCat).sort((a,b)=>a.localeCompare(b,"fr")).forEach(c=>{
      const r = byCat[c];
      const row = document.createElement("div");
      row.className = "trow";
      row.innerHTML = `
        <div class="tname">${esc(c)}</div>
        <div class="tmini">${esc(String(r.n))} tâches · ETH ${esc(String(r.left))}/${esc(String(r.total))}</div>
      `;
      list.appendChild(row);
    });

    wrap.appendChild(list);
    return wrap;
  }

  function renderDrawer(){
    renderTabs();
    drawerBody.innerHTML = "";

    const tab = state.ui.activeTab || "inbox";
    if(tab==="inbox") drawerBody.appendChild(renderDrawerInbox());
    else if(tab==="liste") drawerBody.appendChild(renderDrawerList());
    else if(tab==="cats") drawerBody.appendChild(renderDrawerCats());
    else if(tab==="sets") drawerBody.appendChild(renderDrawerSets());
    else if(tab==="energie") drawerBody.appendChild(renderDrawerEnergy());
    else if(tab==="hist") drawerBody.appendChild(renderDrawerHist());
    else if(tab==="rapport") drawerBody.appendChild(renderDrawerRapport());
    else drawerBody.appendChild(renderDrawerInbox());
  }

  // =========================
  // Notes
  // =========================
  function openNotes(){
    const t = getTask(state.focusId);
    if(!t){
      showToast("AUCUNE CIBLE.", 2200);
      return;
    }

    // quick modal inside drawer (reuse drawer UI)
    openDrawer();
    setTab("inbox"); // just to keep tabs consistent (but we'll override body)
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="cardTitle"><span>Notes</span><span>cible</span></div>
      <textarea id="notesTA" placeholder="Notes">${esc(t.notes||"")}</textarea>
      <div class="rowBtns">
        <button class="btn" id="btnSaveNotes">Enregistrer</button>
      </div>
    `;
    const ta = card.querySelector("#notesTA");
    card.querySelector("#btnSaveNotes").addEventListener("click", ()=>{
      pushHistory("Note enregistrée");
      t.notes = ta.value.slice(0, 12000);
      save();
      renderAll();
      showToast("Note ok.", 2200);
    });

    drawerBody.innerHTML = "";
    drawerBody.appendChild(card);
  }

  // =========================
  // Drawer open/close
  // =========================
  function openDrawer(){
    overlay.classList.add("show");
    drawer.classList.add("show");
    // ensure content fresh
    renderDrawer();
  }
  function closeDrawer(){
    overlay.classList.remove("show");
    drawer.classList.remove("show");
  }

  btnMenu.addEventListener("click", openDrawer);
  btnClose.addEventListener("click", closeDrawer);
  overlay.addEventListener("click", closeDrawer);

  // =========================
  // Buttons wiring
  // =========================
  btnNewDay.addEventListener("click", newDay);
  btnRoulette.addEventListener("click", roulette);
  btnDego.addEventListener("click", degoOne);
  btnNotes.addEventListener("click", openNotes);
  btnDone.addEventListener("click", ()=>{
    const t = getTask(state.focusId);
    if(t) finishTask(t.id);
  });
  btnSkip.addEventListener("click", skip);

  btnUndo.addEventListener("click", undo);
  btnRedo.addEventListener("click", redo);

  // Keyboard
  window.addEventListener("keydown", (e)=>{
    const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
    const inField = (tag==="textarea" || tag==="input" || tag==="select");

    // global esc closes drawer
    if(e.key==="Escape"){
      closeDrawer();
      return;
    }

    if(inField) return;

    if(e.key.toLowerCase()==="r"){ e.preventDefault(); roulette(); return; }
    if(e.key.toLowerCase()==="d"){ e.preventDefault(); degoOne(); return; }

    // undo/redo
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==="z" && !e.shiftKey){
      e.preventDefault(); undo(); return;
    }
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==="z" && e.shiftKey){
      e.preventDefault(); redo(); return;
    }

    // menu
    if(e.key.toLowerCase()==="m"){
      e.preventDefault();
      openDrawer();
      return;
    }
  });

  // =========================
  // Toast + FX
  // =========================
  function showToast(msg, ms=2600){
    toast.textContent = msg;
    toast.classList.add("show");
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>toast.classList.remove("show"), ms);
  }

  function resizeFx(){
    fxCanvas.width = window.innerWidth * devicePixelRatio;
    fxCanvas.height = window.innerHeight * devicePixelRatio;
    fx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
  }
  window.addEventListener("resize", resizeFx);
  resizeFx();

  function confetti(strength=1){
    const W = window.innerWidth, H = window.innerHeight;
    const cx = W/2, cy = H*0.64;
    const n = Math.floor(75*strength);
    const parts = [];
    for(let i=0;i<n;i++){
      const a = -Math.PI/2 + (Math.random()-0.5)*1.7;
      const sp = (3 + Math.random()*8)*strength;
      parts.push({ x:cx, y:cy, vx:Math.cos(a)*sp, vy:Math.sin(a)*sp, life: 55+Math.random()*35, r: 1+Math.random()*3 });
    }
    let f=0;
    const tick=()=>{
      f++;
      fx.clearRect(0,0,W,H);
      fx.fillStyle="rgba(230,230,230,0.88)";
      for(const p of parts){
        p.x += p.vx; p.y += p.vy;
        p.vy += 0.14;
        p.life -= 1;
        fx.globalAlpha = Math.max(0, p.life/90);
        fx.beginPath();
        fx.arc(p.x,p.y,p.r,0,Math.PI*2);
        fx.fill();
      }
      if(f<85) requestAnimationFrame(tick);
      else fx.clearRect(0,0,W,H);
    };
    requestAnimationFrame(tick);
  }

  function flash(){
    const div = document.createElement("div");
    div.style.position="fixed";
    div.style.inset="0";
    div.style.background="rgba(242,242,242,0.08)";
    div.style.pointerEvents="none";
    div.style.zIndex="115";
    div.style.opacity="0";
    div.style.transition="opacity 120ms ease";
    document.body.appendChild(div);
    requestAnimationFrame(()=> div.style.opacity="1");
    setTimeout(()=> div.style.opacity="0", 160);
    setTimeout(()=> div.remove(), 420);
  }

  const LINES = [
    "ETHORION DÉGOMMÉ.",
    "CHARGE RÉDUITE.",
    "COUP NET.",
    "ENCORE.",
    "PROPRE."
  ];
  const DONE_LINES = [
    "CIBLE EXTERMINÉE.",
    "TERMINÉ.",
    "ÉLIMINATION CONFIRMÉE.",
    "MISSION FINIE."
  ]
  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  // =========================
  // Init
  // =========================
  function init(){
    ensureDay();

    // ensure focus exists
    if(state.focusId && !getTask(state.focusId)) state.focusId = null;
    if(!state.focusId){
      const t = pickWeightedTask();
      state.focusId = t ? t.id : null;
    }

    save();
    renderAll();
    showToast("PRÊT.", 2000);
  }

  init();

})();
</script>
</body>
</html
