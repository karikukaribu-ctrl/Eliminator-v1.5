<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Eliminator</title>
  <style>
    :root{
      --bg:#0f1115;
      --fg:#e9edf5;
      --muted:#a8b0bd;
      --line:rgba(255,255,255,0.10);
      --soft:rgba(255,255,255,0.06);
      --chip:#0b0d12;
      --panel:#121624;
      --panel2:#0c0f18;
      --accent1:#f2f2f2;
      --accent2:#aeb7c7;
      --danger:#ffb3b3;
      --ok:#b7f7d6;

      --r:16px;
      --shadow:0 18px 45px rgba(0,0,0,.55);
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--fg);
      overflow-x:hidden;
    }

    /* Layout */
    .app{
      min-height:100%;
      display:grid;
      grid-template-columns: 1fr;
    }
    @media (min-width: 980px){
      .app{
        grid-template-columns: 74px 1fr 420px; /* rail | focus | lists */
      }
      body.focusOnly .app{
        grid-template-columns: 74px 1fr; /* hide lists column */
      }
    }

    /* Rail */
    .rail{
      position:sticky;
      top:0;
      height:100vh;
      padding:10px;
      border-right:1px solid var(--soft);
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      display:flex;
      flex-direction:column;
      gap:8px;
      z-index:10;
    }
    .rail .logo{
      border:1px solid var(--soft);
      border-radius:14px;
      padding:10px 8px;
      text-align:center;
      font-weight:950;
      letter-spacing:0.08em;
      text-transform:uppercase;
      font-size:11px;
      color:var(--muted);
      user-select:none;
    }
    .rail .btn{
      border:1px solid var(--soft);
      background:transparent;
      color:var(--fg);
      border-radius:14px;
      padding:10px 8px;
      cursor:pointer;
      font-weight:900;
      font-size:12px;
      letter-spacing:0.02em;
    }
    .rail .btn:hover{ border-color: rgba(242,242,242,0.18); }
    .rail .btn:active{ transform: translateY(1px); }
    .rail .btn.active{
      border-color: rgba(242,242,242,0.25);
      background: linear-gradient(90deg, rgba(242,242,242,0.10), rgba(174,183,199,0.08));
    }
    .rail .spacer{ flex:1; }
    .rail .tiny{
      color:var(--muted);
      font-size:11px;
      text-align:center;
      line-height:1.2;
      padding:6px 2px;
      user-select:none;
    }

    /* Main focus area */
    .main{
      padding:12px;
      display:grid;
      align-content:start;
      gap:12px;
    }
    @media (max-width: 979px){
      .main{
        padding-bottom: 90px; /* space for mobile action bar */
      }
    }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    .title{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .title h1{
      margin:0;
      font-size:18px;
      font-weight:950;
      letter-spacing:0.2px;
      line-height:1.1;
    }
    .title .sub{
      font-size:12px;
      color:var(--muted);
      letter-spacing:0.04em;
    }

    .metaLine{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border:1px solid var(--soft);
      background:rgba(0,0,0,0.10);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      font-weight:850;
      line-height:1;
      white-space:nowrap;
    }
    .tag b{
      color:var(--fg);
      font-weight:950;
    }

    .focusCard{
      border:1px solid rgba(242,242,242,0.10);
      background:
        radial-gradient(900px 260px at 30% 20%, rgba(242,242,242,0.14), transparent 60%),
        linear-gradient(180deg, var(--panel), var(--panel2));
      border-radius: 20px;
      padding: 16px;
      box-shadow: var(--shadow);
      display:grid;
      gap:12px;
    }

    .focusTask{
      font-size: 22px;
      font-weight: 950;
      line-height: 1.15;
      word-break: break-word;
    }
    .focusHint{
      color:var(--muted);
      font-size:12px;
      line-height:1.25;
      margin-top:-4px;
    }

    /* Progress bar (FULL -> DECREASES) */
    .barWrap{
      border-radius: 999px;
      height: 16px;
      background: rgba(255,255,255,0.06);
      overflow:hidden;
      position:relative;
    }
    .barFill{
      height:100%;
      width:100%;
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      transition: width 220ms ease;
    }
    .barLabel{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:11px;
      font-weight:950;
      color: rgba(10,12,16,0.90);
      mix-blend-mode: screen;
      letter-spacing:0.06em;
      text-transform:uppercase;
      user-select:none;
    }

    .focusRow{
      display:flex;
      gap:10px;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
    }

    .bigActions{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    @media (min-width: 520px){
      .bigActions{ grid-template-columns: 1fr 1fr; }
    }

    .bigBtn{
      border:1px solid rgba(242,242,242,0.14);
      background:
        radial-gradient(900px 260px at 30% 20%, rgba(242,242,242,0.14), transparent 60%),
        linear-gradient(180deg, #0b0d12, #0a0c10);
      color:var(--fg);
      border-radius: 18px;
      padding: 16px 14px;
      cursor:pointer;
      font-weight: 950;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      min-height: 58px;
    }
    .bigBtn:hover{ border-color: rgba(242,242,242,0.28); }
    .bigBtn:active{ transform: translateY(1px); }
    .bigBtn:disabled{ opacity:0.5; cursor:not-allowed; }

    .bigBtn.primary{
      background:
        radial-gradient(900px 260px at 30% 20%, rgba(242,242,242,0.22), transparent 60%),
        linear-gradient(90deg, rgba(242,242,242,0.10), rgba(174,183,199,0.10)),
        linear-gradient(180deg, #0b0d12, #0a0c10);
    }

    .smallActions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .btnSmall{
      border:1px solid var(--soft);
      background:transparent;
      color:var(--fg);
      border-radius:14px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:900;
      font-size:12px;
      letter-spacing:0.04em;
    }
    .btnSmall:hover{ border-color: rgba(242,242,242,0.18); }
    .btnSmall:active{ transform: translateY(1px); }
    .btnSmall.danger{ border-color: rgba(255,179,179,0.20); }
    .btnSmall.ok{ border-color: rgba(183,247,214,0.16); }

    /* Lists column */
    .lists{
      padding:12px 12px 16px 0;
      display:grid;
      gap:10px;
      align-content:start;
      border-left:1px solid var(--soft);
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
    }
    @media (max-width: 979px){
      .lists{
        border-left:none;
        padding:0 12px 12px;
      }
      body.focusOnly .lists{ display:none; }
    }

    .panel{
      border:1px solid var(--soft);
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      padding: 12px;
      display:none;
      gap:10px;
    }
    body.panelOpen .panel{ display:grid; }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .row .left, .row .right{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }

    textarea, select, input[type="text"], input[type="number"]{
      font:inherit;
      border:1px solid var(--soft);
      background: var(--chip);
      color: var(--fg);
      border-radius: 14px;
      padding: 10px 12px;
      outline:none;
      font-size:13px;
    }
    textarea{ width:100%; min-height: 96px; resize: vertical; line-height:1.35; }
    textarea:focus, select:focus, input:focus{ border-color: rgba(242,242,242,0.22); }

    .listBlock{
      display:grid;
      gap:8px;
    }
    .blockTitle{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:10px;
      color:var(--muted);
      font-weight:950;
      letter-spacing:0.10em;
      text-transform:uppercase;
      font-size:11px;
    }

    /* Task rows: mostly text */
    .taskRow{
      border:1px solid rgba(255,255,255,0.06);
      border-radius: 16px;
      background: rgba(0,0,0,0.12);
      padding: 10px 10px;
      display:grid;
      gap:8px;
    }
    .taskLine{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    .taskText{
      font-weight:900;
      line-height:1.2;
      word-break: break-word;
      font-size:14px;
    }
    .taskMini{
      color:var(--muted);
      font-size:12px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .taskMini .dot{ opacity:.6; }

    .taskActions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .iconBtn{
      border:1px solid var(--soft);
      background:transparent;
      color:var(--fg);
      border-radius: 12px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:900;
      font-size:12px;
      white-space:nowrap;
    }
    .iconBtn:hover{ border-color: rgba(242,242,242,0.18); }
    .iconBtn:active{ transform: translateY(1px); }

    .editInline{
      display:none;
      gap:8px;
      grid-template-columns: 1fr 1fr;
    }
    @media (min-width: 520px){
      .editInline{ grid-template-columns: 1fr 1fr 1fr 1fr; }
    }
    .taskRow.open .editInline{ display:grid; }

    .muted{ color:var(--muted); }

    .done{
      text-decoration: line-through;
      opacity: 0.55;
    }

    /* Mobile bottom bar */
    .mobileBar{
      display:none;
    }
    @media (max-width: 979px){
      .mobileBar{
        display:flex;
        position:fixed;
        left:12px; right:12px; bottom:12px;
        gap:10px;
        z-index:20;
      }
      .mobileBar .bigBtn{ flex:1; min-height: 56px; }
    }

    /* Toast + FX canvas */
    .toast{
      position:fixed;
      left:50%;
      bottom: 84px;
      transform:translateX(-50%);
      background:#0b0d12;
      border:1px solid rgba(255,255,255,0.10);
      border-radius: 14px;
      padding:10px 12px;
      color:var(--fg);
      font-size:13px;
      opacity:0;
      pointer-events:none;
      transition: opacity 140ms ease, transform 140ms ease;
      max-width: min(900px, calc(100vw - 24px));
      box-shadow: var(--shadow);
      white-space:pre-wrap;
      z-index:50;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(-6px); }
    canvas#fx{ position:fixed; inset:0; pointer-events:none; z-index:40; }

    /* Drag affordance */
    .taskRow[draggable="true"]{ cursor:grab; }
    .taskRow.dragging{ opacity:0.6; }
    .dropZone{
      outline: 2px dashed rgba(242,242,242,0.18);
      outline-offset: 6px;
      border-radius: 16px;
    }
  </style>
</head>

<body class="panelOpen">
  <canvas id="fx"></canvas>

  <div class="app">
    <!-- Rail -->
    <aside class="rail" aria-label="Navigation">
      <div class="logo">Eliminator</div>

      <button class="btn active" id="navFocus" title="Focus (F)">Focus</button>
      <button class="btn" id="navLists" title="Listes">Listes</button>
      <button class="btn" id="navInbox" title="Inbox">Inbox</button>

      <button class="btn" id="navPanel" title="Panneau">Panneau</button>
      <button class="btn" id="navPresetPrev" title="Preset précédent (Alt+←)">◀</button>
      <button class="btn" id="navPresetNext" title="Preset suivant (Alt+→)">▶</button>

      <div class="spacer"></div>

      <button class="btn" id="navUndo" title="Undo (Ctrl/⌘+Z)">Undo</button>
      <button class="btn" id="navRedo" title="Redo (Ctrl/⌘+Shift+Z)">Redo</button>
      <button class="btn" id="navExport" title="Export JSON">Export</button>
      <button class="btn" id="navImport" title="Import JSON">Import</button>

      <div class="tiny" id="presetLabel">Base</div>
    </aside>

    <!-- Focus column -->
    <main class="main" aria-label="Focus">
      <div class="topbar">
        <div class="title">
          <h1>Eliminator</h1>
          <div class="sub">des gommes d'ethorion</div>
        </div>

        <div class="metaLine" aria-label="Statistiques">
          <span class="tag">Tâches <b id="statTasks">0</b></span>
          <span class="tag">Torions <b id="statTorions">0</b></span>
          <span class="tag">Reste <b id="statTorionsLeft">0</b></span>
        </div>
      </div>

      <section class="focusCard" aria-label="Carte Focus">
        <div class="focusTask" id="focusText">Aucune</div>
        <div class="focusHint" id="focusSub">Roulette → choisir. Dégommer → réduire.</div>

        <!-- BAR: full -> decreases with remaining -->
        <div class="barWrap" aria-label="Barre de charge">
          <div class="barFill" id="barFill"></div>
          <div class="barLabel" id="barLabel">100%</div>
        </div>

        <div class="focusRow">
          <div class="metaLine">
            <span class="tag">Restant <b id="focusTorions">0</b></span>
            <span class="tag">Minuteur <b id="focusTimer">—</b></span>
          </div>

          <div class="smallActions">
            <button class="btnSmall" id="btnTimer">Démarrer</button>
            <button class="btnSmall ok" id="btnDone">Terminer</button>
            <button class="btnSmall danger" id="btnSkip">Passer</button>
          </div>
        </div>

        <div class="bigActions">
          <button class="bigBtn primary" id="btnRoulette">Roulette</button>
          <button class="bigBtn" id="btnDego">Dégommer 1 torion</button>
        </div>
      </section>

      <!-- Mobile quick actions -->
      <div class="mobileBar" aria-label="Actions rapides">
        <button class="bigBtn primary" id="btnRouletteMobile">Roulette</button>
        <button class="bigBtn" id="btnDegoMobile">Dégommer</button>
      </div>
    </main>

    <!-- Lists column -->
    <section class="lists" aria-label="Listes">
      <section class="panel" aria-label="Panneau">
        <div class="row">
          <div class="left">
            <span class="tag">Torion = <b id="torionMinLabel">5</b> min</span>
            <select id="selTorionMin" aria-label="Durée d'un torion">
              <option value="5">5 min</option>
              <option value="10">10 min</option>
            </select>
          </div>
          <div class="right">
            <button class="btnSmall" id="btnPresetAdd">+ Preset</button>
            <button class="btnSmall" id="btnPresetEdit">Éditer</button>
            <button class="btnSmall danger" id="btnPresetDel">Suppr</button>
          </div>
        </div>

        <div class="row">
          <div class="left">
            <select id="selEnergyFilter" aria-label="Filtre énergie">
              <option value="tous">Énergie: tous</option>
              <option value="faible">Énergie: faible</option>
              <option value="moyen">Énergie: moyen</option>
              <option value="haut">Énergie: haut</option>
            </select>
            <select id="selSort" aria-label="Tri">
              <option value="order">Tri: ordre</option>
              <option value="priority">Tri: priorité</option>
              <option value="torions">Tri: torions restants</option>
              <option value="category">Tri: catégorie</option>
            </select>
          </div>
          <div class="right">
            <button class="btnSmall ok" id="btnUndo">Undo</button>
            <button class="btnSmall ok" id="btnRedo">Redo</button>
          </div>
        </div>

        <div class="row">
          <div class="left">
            <button class="btnSmall" id="btnExport">Export</button>
            <button class="btnSmall" id="btnImport">Import</button>
          </div>
          <div class="right">
            <button class="btnSmall danger" id="btnReset">Reset</button>
          </div>
        </div>
      </section>

      <section class="listBlock" aria-label="Inbox">
        <div class="blockTitle">
          <span>Inbox</span>
          <span class="muted">Ctrl/⌘+Enter</span>
        </div>
        <textarea id="taInbox" placeholder="" aria-label="Saisie Inbox (une ligne = une tâche)"></textarea>
        <div class="row" style="justify-content:flex-end;">
          <div class="right">
            <button class="btnSmall ok" id="btnAdd">Ajouter</button>
          </div>
        </div>
        <div id="listInbox"></div>
      </section>

      <section class="listBlock" aria-label="Tri">
        <div class="blockTitle">
          <span>Liste</span>
          <span class="muted">drag & drop</span>
        </div>
        <div id="listMain"></div>
      </section>

      <section class="listBlock" aria-label="Terminé">
        <div class="blockTitle">
          <span>Terminé</span>
          <span class="muted">récents</span>
        </div>
        <div id="listDone"></div>
      </section>
    </section>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

<script>
(() => {
  "use strict";

  const LS_KEY = "eliminator_ultra_min_v2";

  const el = (id) => document.getElementById(id);
  const fxCanvas = el("fx");
  const fx = fxCanvas.getContext("2d");

  // Rail
  const navFocus = el("navFocus");
  const navLists = el("navLists");
  const navInbox = el("navInbox");
  const navPanel = el("navPanel");
  const navPresetPrev = el("navPresetPrev");
  const navPresetNext = el("navPresetNext");
  const navUndo = el("navUndo");
  const navRedo = el("navRedo");
  const navExport = el("navExport");
  const navImport = el("navImport");
  const presetLabel = el("presetLabel");

  // Focus UI
  const statTasks = el("statTasks");
  const statTorions = el("statTorions");
  const statTorionsLeft = el("statTorionsLeft");

  const focusText = el("focusText");
  const focusSub = el("focusSub");
  const barFill = el("barFill");
  const barLabel = el("barLabel");
  const focusTorions = el("focusTorions");
  const focusTimer = el("focusTimer");

  const btnRoulette = el("btnRoulette");
  const btnDego = el("btnDego");
  const btnRouletteMobile = el("btnRouletteMobile");
  const btnDegoMobile = el("btnDegoMobile");
  const btnTimer = el("btnTimer");
  const btnDone = el("btnDone");
  const btnSkip = el("btnSkip");

  // Panel / Lists UI
  const selTorionMin = el("selTorionMin");
  const torionMinLabel = el("torionMinLabel");
  const selEnergyFilter = el("selEnergyFilter");
  const selSort = el("selSort");

  const btnPresetAdd = el("btnPresetAdd");
  const btnPresetEdit = el("btnPresetEdit");
  const btnPresetDel = el("btnPresetDel");

  const btnUndo = el("btnUndo");
  const btnRedo = el("btnRedo");

  const btnExport = el("btnExport");
  const btnImport = el("btnImport");
  const btnReset = el("btnReset");

  const taInbox = el("taInbox");
  const btnAdd = el("btnAdd");

  const listInbox = el("listInbox");
  const listMain = el("listMain");
  const listDone = el("listDone");

  const toast = el("toast");

  // ---------- State ----------
  const MAX_HISTORY = 40;

  let state = load() || makeInitial();

  function makeInitial(){
    return {
      version: 2,
      torionMinutes: 5,
      activePresetId: "p_default",
      presets: [{
        id:"p_default",
        name:"Base",
        defaults:{
          context:"Travail",
          category:"Sans catégorie",
          priority:2,
          torions:3,
          energy:"moyen"
        }
      }],
      tasks: [],
      focus: { taskId:null, running:false, endsAt:null, secondsLeft:0 },
      ui: { panelOpen:true, energyFilter:"tous", sort:"order", focusOnly:false },
      history: { undo:[], redo:[] },
      fun: { sound:false } // option interne (désactivé)
    };
  }

  function save(){
    localStorage.setItem(LS_KEY, JSON.stringify(state));
  }

  function load(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return null;
      const obj = JSON.parse(raw);
      if(!obj || !Array.isArray(obj.tasks) || !Array.isArray(obj.presets)) return null;
      return obj;
    }catch{
      return null;
    }
  }

  function pushHistory(){
    const snapshot = structuredClone({ ...state, history:{undo:[], redo:[]} });
    state.history.undo.push(snapshot);
    if(state.history.undo.length > MAX_HISTORY) state.history.undo.shift();
    state.history.redo = [];
    save();
    updateUndoRedo();
  }

  function undo(){
    if(!state.history.undo.length) return;
    const prev = state.history.undo.pop();
    const current = structuredClone({ ...state, history:{undo:[], redo:[]} });
    state.history.redo.push(current);
    state = { ...prev, history: state.history };
    save();
    renderAll();
  }

  function redo(){
    if(!state.history.redo.length) return;
    const next = state.history.redo.pop();
    const current = structuredClone({ ...state, history:{undo:[], redo:[]} });
    state.history.undo.push(current);
    state = { ...next, history: state.history };
    save();
    renderAll();
  }

  function updateUndoRedo(){
    const u = state.history.undo.length > 0;
    const r = state.history.redo.length > 0;
    btnUndo.disabled = !u;
    btnRedo.disabled = !r;
    navUndo.disabled = !u;
    navRedo.disabled = !r;
  }

  // ---------- Helpers ----------
  const now = () => Date.now();
  const clamp = (n,a,b)=> Math.max(a, Math.min(b,n));
  const uid = () => Math.random().toString(36).slice(2,10)+"-"+Date.now().toString(36);

  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add("show");
    setTimeout(()=> toast.classList.remove("show"), 1100);
  }

  function activePreset(){
    return state.presets.find(p=>p.id===state.activePresetId) || state.presets[0];
  }

  function setPresetLabel(){
    presetLabel.textContent = activePreset().name;
  }

  // ---------- Minimal "fun" (safe) ----------
  const LINES = [
    "Torion dégommé.",
    "Charge réduite.",
    "Un cran de moins.",
    "C’est propre.",
    "On avance."
  ];
  const BIG_LINES = [
    "Extermination confirmée.",
    "Dossier dissous.",
    "Fin de mission."
  ];

  function resizeFx(){
    fxCanvas.width = window.innerWidth * devicePixelRatio;
    fxCanvas.height = window.innerHeight * devicePixelRatio;
    fx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
  }
  window.addEventListener("resize", resizeFx);
  resizeFx();

  function confetti(strength=1){
    const W = window.innerWidth, H = window.innerHeight;
    const cx = W/2, cy = Math.min(H-140, H*0.70);
    const n = Math.floor(36*strength);
    const parts = [];
    for(let i=0;i<n;i++){
      const a = -Math.PI/2 + (Math.random()-0.5)*1.4;
      const sp = (2 + Math.random()*5)*strength;
      parts.push({ x:cx, y:cy, vx:Math.cos(a)*sp, vy:Math.sin(a)*sp, life: 40+Math.random()*25, r:1+Math.random()*2 });
    }
    let f=0;
    const tick=()=>{
      f++;
      fx.clearRect(0,0,W,H);
      fx.fillStyle="rgba(230,230,230,0.85)";
      for(const p of parts){
        p.x += p.vx;
        p.y += p.vy;
        p.vy += 0.12;
        p.life -= 1;
        fx.globalAlpha = Math.max(0, p.life/70);
        fx.beginPath();
        fx.arc(p.x,p.y,p.r,0,Math.PI*2);
        fx.fill();
      }
      if(f<60) requestAnimationFrame(tick);
      else fx.clearRect(0,0,W,H);
    };
    requestAnimationFrame(tick);
  }

  // ---------- Task heuristics (simple) ----------
  function suggestFields(text){
    const t = (text||"").toLowerCase();
    const preset = activePreset();
    let { context, category, priority, torions, energy } = preset.defaults;

    const has = (re)=>re.test(t);

    if(has(/\b(appeler|tel|téléphone|contacter)\b/)){
      category="Appels"; torions=1; energy="faible";
    }
    if(has(/\b(encoder|encodage|note)\b/)){
      category="Encodage"; torions=Math.max(torions,3); energy="faible";
    }
    if(has(/\b(rapport|rédaction|lettre|dossier)\b/)){
      category="Rédaction"; torions=Math.max(torions,5); energy="moyen";
    }
    if(has(/\b(urgent|aujourd)\b/)){
      priority=3;
    }
    if(has(/\b(maison|perso)\b/)){
      context="Maison";
    }
    if(has(/\b(travail|hopital|hôpital|patient)\b/)){
      context="Travail";
    }
    const m = t.match(/(?:\(|\s)(\d{1,2})\s*(?:t|torion|torions)\b/);
    if(m){
      torions = clamp(parseInt(m[1],10)||torions,1,50);
    }
    return { context, category, priority, torions, energy };
  }

  // ---------- Data operations ----------
  function addTasksFromInbox(){
    const raw = taInbox.value || "";
    const lines = raw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    if(!lines.length){ showToast("Vide."); return; }

    pushHistory();

    const startOrder = nextOrder("inbox");
    lines.forEach((line, idx)=>{
      const sug = suggestFields(line);
      state.tasks.push({
        id: uid(),
        text: line,
        list: "inbox",
        order: startOrder + idx,
        context: sug.context,
        category: sug.category,
        priority: sug.priority,
        energy: sug.energy,
        torionsTotal: sug.torions,
        torionsRemaining: sug.torions,
        createdAt: now(),
        updatedAt: now(),
        doneAt: null
      });
    });

    taInbox.value = "";
    save();
    renderAll();
    showToast("Ajouté.");
  }

  function nextOrder(list){
    const items = state.tasks.filter(t=>t.list===list);
    if(!items.length) return 1;
    return Math.max(...items.map(t=>t.order||0)) + 1;
  }

  function getTask(id){
    return state.tasks.find(t=>t.id===id) || null;
  }

  function sumTorionsRemaining(){
    return state.tasks.reduce((acc,t)=> acc + ((t.list==="done")?0:(t.torionsRemaining||0)), 0);
  }

  function sumTorionsTotalActive(){
    return state.tasks.reduce((acc,t)=> acc + ((t.list==="done")?0:(t.torionsTotal||0)), 0);
  }

  function countActiveTasks(){
    return state.tasks.filter(t=>t.list!=="done").length;
  }

  function chooseWeightedTask(){
    const energyFilter = state.ui.energyFilter || "tous";
    const pool = state.tasks
      .filter(t=>t.list!=="done")
      .filter(t=>(t.torionsRemaining||0) > 0)
      .filter(t=> energyFilter==="tous" ? true : (t.energy||"moyen")===energyFilter);

    if(!pool.length) return null;

    // pondération simple (sans mécanique d’exploitation): torions restants + priorité
    const weights = pool.map(t => Math.max(1, Math.ceil(t.torionsRemaining)) + (t.priority===3?2:(t.priority===1?-0.5:0)));
    const total = weights.reduce((a,b)=>a+b,0);
    let r = Math.random()*total;
    for(let i=0;i<pool.length;i++){
      r -= weights[i];
      if(r <= 0) return pool[i];
    }
    return pool[pool.length-1];
  }

  function setFocus(taskId){
    state.focus.taskId = taskId;
    state.focus.running = false;
    state.focus.endsAt = null;
    state.focus.secondsLeft = 0;
    save();
    renderFocus();
    renderStats();
  }

  function finishTask(taskId){
    const t = getTask(taskId);
    if(!t) return;
    pushHistory();
    t.list = "done";
    t.doneAt = now();
    t.torionsRemaining = 0;
    t.updatedAt = now();
    if(state.focus.taskId === taskId){
      stopTimer();
      state.focus.taskId = null;
    }
    save();
    renderAll();
    confetti(1.4);
    showToast(BIG_LINES[Math.floor(Math.random()*BIG_LINES.length)]);
  }

  function deleteTask(taskId){
    if(!confirm("Supprimer ?")) return;
    pushHistory();
    if(state.focus.taskId === taskId){
      stopTimer();
      state.focus.taskId = null;
    }
    state.tasks = state.tasks.filter(x=>x.id!==taskId);
    save();
    renderAll();
    showToast("Supprimé.");
  }

  function toggleList(taskId){
    const t = getTask(taskId);
    if(!t) return;
    pushHistory();
    t.list = (t.list === "inbox") ? "main" : "inbox";
    t.order = nextOrder(t.list);
    t.updatedAt = now();
    save();
    renderAll();
  }

  function degoOneTorion(){
    const t = getTask(state.focus.taskId);
    if(!t){ showToast("Aucune."); return; }
    if(t.torionsRemaining <= 0){ return; }

    pushHistory();
    t.torionsRemaining = Math.max(0, t.torionsRemaining - 1);
    t.updatedAt = now();
    save();

    // Feedback fun mais simple
    const msg = LINES[Math.floor(Math.random()*LINES.length)];
    showToast(msg);

    if(t.torionsRemaining === 0){
      confetti(1.6);
      finishTask(t.id);
      return;
    }else{
      confetti(0.7);
    }

    renderAll();
  }

  // ---------- Timer ----------
  let timerHandle = null;

  function startTimer(){
    const t = getTask(state.focus.taskId);
    if(!t) return;

    const seconds = (state.torionMinutes||5) * 60;
    state.focus.running = true;
    state.focus.secondsLeft = seconds;
    state.focus.endsAt = now() + seconds*1000;
    save();
    renderFocus();
    scheduleTick();
  }

  function pauseTimer(){
    state.focus.running = false;
    state.focus.endsAt = null;
    save();
    renderFocus();
    if(timerHandle){ clearInterval(timerHandle); timerHandle=null; }
  }

  function stopTimer(){
    state.focus.running = false;
    state.focus.endsAt = null;
    state.focus.secondsLeft = 0;
    if(timerHandle){ clearInterval(timerHandle); timerHandle=null; }
    save();
  }

  function scheduleTick(){
    if(timerHandle) clearInterval(timerHandle);
    timerHandle = setInterval(()=>{
      if(!state.focus.running || !state.focus.endsAt) return;
      const leftMs = state.focus.endsAt - now();
      const left = Math.max(0, Math.ceil(leftMs/1000));
      state.focus.secondsLeft = left;
      if(left<=0){
        pauseTimer();
        degoOneTorion();
        return;
      }
      save();
      renderFocus();
    }, 250);
  }

  function fmtTimer(s){
    if(!Number.isFinite(s) || s<=0) return "—";
    const m = Math.floor(s/60);
    const r = s%60;
    return `${String(m).padStart(2,"0")}:${String(r).padStart(2,"0")}`;
  }

  // ---------- Rendering ----------
  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[c]));
  }

  function renderStats(){
    const tasks = countActiveTasks();
    const tot = sumTorionsTotalActive();
    const left = sumTorionsRemaining();

    statTasks.textContent = String(tasks);
    statTorions.textContent = String(tot);
    statTorionsLeft.textContent = String(left);

    torionMinLabel.textContent = String(state.torionMinutes||5);
    setPresetLabel();

    navUndo.disabled = state.history.undo.length===0;
    navRedo.disabled = state.history.redo.length===0;
  }

  function renderFocus(){
    const t = getTask(state.focus.taskId);

    if(!t){
      focusText.textContent = "Aucune";
      focusSub.textContent = "Roulette → choisir. Dégommer → réduire.";
      focusTorions.textContent = "0";
      focusTimer.textContent = "—";
      barFill.style.width = "100%";
      barLabel.textContent = "100%";
      btnDego.disabled = true;
      btnDone.disabled = true;
      btnSkip.disabled = true;
      return;
    }

    focusText.textContent = t.text;
    focusSub.textContent = `${t.context} · ${t.category} · P${t.priority} · ${t.energy}`;
    focusTorions.textContent = String(t.torionsRemaining || 0);
    focusTimer.textContent = fmtTimer(state.focus.secondsLeft);

    const total = Math.max(1, t.torionsTotal || 1);
    const rem = clamp(t.torionsRemaining||0, 0, total);
    const pctLeft = Math.round((rem/total)*100);
    barFill.style.width = `${pctLeft}%`;
    barLabel.textContent = `${pctLeft}%`;

    btnDego.disabled = false;
    btnDone.disabled = false;
    btnSkip.disabled = false;

    btnTimer.textContent = state.focus.running ? "Pause" : "Démarrer";
  }

  function sortTasks(items){
    const mode = state.ui.sort || "order";
    const by = {
      order: (a,b)=> (a.order||0) - (b.order||0),
      priority: (a,b)=> (b.priority||2) - (a.priority||2),
      torions: (a,b)=> (b.torionsRemaining||0) - (a.torionsRemaining||0),
      category: (a,b)=> String(a.category||"").localeCompare(String(b.category||""), "fr")
    }[mode] || ((a,b)=> (a.order||0)-(b.order||0));

    return items.slice().sort(by);
  }

  function filtered(listName){
    const ef = state.ui.energyFilter || "tous";
    return sortTasks(
      state.tasks
        .filter(t=>t.list===listName)
        .filter(t=> ef==="tous" ? true : (t.energy||"moyen")===ef)
    );
  }

  function renderTaskRow(t){
    const wrap = document.createElement("div");
    wrap.className = "taskRow";
    wrap.draggable = true;
    wrap.dataset.id = t.id;

    const total = Math.max(1, t.torionsTotal||1);
    const rem = clamp(t.torionsRemaining||0, 0, total);

    wrap.innerHTML = `
      <div class="taskLine">
        <div>
          <div class="taskText">${escapeHtml(t.text)}</div>
          <div class="taskMini">
            <span>${escapeHtml(t.context||"—")}</span>
            <span class="dot">·</span>
            <span>${escapeHtml(t.category||"—")}</span>
            <span class="dot">·</span>
            <span>P${escapeHtml(String(t.priority||2))}</span>
            <span class="dot">·</span>
            <span>${escapeHtml(String(rem))}/${escapeHtml(String(total))} torions</span>
          </div>
        </div>
        <div class="taskActions">
          <button class="iconBtn" data-act="open">Détails</button>
          <button class="iconBtn" data-act="focus">Focus</button>
          <button class="iconBtn" data-act="move">${t.list==="inbox" ? "→" : "←"}</button>
          <button class="iconBtn" data-act="done">OK</button>
          <button class="iconBtn" data-act="del">X</button>
        </div>
      </div>

      <div class="editInline">
        <select data-field="context" aria-label="Contexte">
          ${opt(t.context, ["Travail","Maison","Dehors","Autre"])}
        </select>

        <input type="text" data-field="category" aria-label="Catégorie" value="${escapeAttr(t.category||"")}" />

        <select data-field="priority" aria-label="Priorité">
          ${opt(String(t.priority||2), ["1","2","3"])}
        </select>

        <select data-field="energy" aria-label="Énergie">
          ${opt(t.energy||"moyen", ["faible","moyen","haut"])}
        </select>

        <input type="number" min="1" max="50" step="1" data-field="torionsTotal" aria-label="Torions total" value="${escapeAttr(String(t.torionsTotal||1))}" />
      </div>
    `;

    // Actions
    wrap.querySelector('[data-act="open"]').addEventListener("click", ()=>{
      wrap.classList.toggle("open");
    });
    wrap.querySelector('[data-act="focus"]').addEventListener("click", ()=>{
      setFocus(t.id);
      showToast("Focus.");
    });
    wrap.querySelector('[data-act="move"]').addEventListener("click", ()=> toggleList(t.id));
    wrap.querySelector('[data-act="done"]').addEventListener("click", ()=> finishTask(t.id));
    wrap.querySelector('[data-act="del"]').addEventListener("click", ()=> deleteTask(t.id));

    // Edits
    wrap.querySelectorAll("[data-field]").forEach(inp=>{
      inp.addEventListener("change", ()=>{
        pushHistory();
        const field = inp.dataset.field;
        const task = getTask(t.id);
        if(!task) return;

        if(field==="torionsTotal"){
          const v = clamp(parseInt(inp.value,10)||1, 1, 50);
          task.torionsTotal = v;
          task.torionsRemaining = clamp(task.torionsRemaining ?? v, 0, v);
        }else if(field==="priority"){
          task.priority = clamp(parseInt(inp.value,10)||2, 1, 3);
        }else if(field==="energy"){
          task.energy = inp.value;
        }else if(field==="context"){
          task.context = inp.value;
        }else if(field==="category"){
          task.category = (inp.value||"").trim() || "Sans catégorie";
        }
        task.updatedAt = now();
        save();
        renderAll();
      });
    });

    // Drag behavior
    wrap.addEventListener("dragstart", (e)=>{
      wrap.classList.add("dragging");
      e.dataTransfer.setData("text/plain", t.id);
      e.dataTransfer.effectAllowed="move";
    });
    wrap.addEventListener("dragend", ()=>{
      wrap.classList.remove("dragging");
      listInbox.classList.remove("dropZone");
      listMain.classList.remove("dropZone");
    });

    return wrap;
  }

  function renderDoneRow(t){
    const wrap = document.createElement("div");
    wrap.className = "taskRow";
    wrap.innerHTML = `
      <div class="taskLine">
        <div class="taskText done">${escapeHtml(t.text)}</div>
        <div class="taskActions">
          <button class="iconBtn" data-act="restore">Restaurer</button>
          <button class="iconBtn" data-act="del">X</button>
        </div>
      </div>
    `;
    wrap.querySelector('[data-act="restore"]').addEventListener("click", ()=>{
      pushHistory();
      t.list = "main";
      t.doneAt = null;
      t.torionsRemaining = Math.max(1, t.torionsTotal||1);
      t.order = nextOrder("main");
      t.updatedAt = now();
      save();
      renderAll();
    });
    wrap.querySelector('[data-act="del"]').addEventListener("click", ()=> deleteTask(t.id));
    return wrap;
  }

  function renderLists(){
    listInbox.innerHTML = "";
    listMain.innerHTML = "";
    listDone.innerHTML = "";

    filtered("inbox").forEach(t=> listInbox.appendChild(renderTaskRow(t)));
    filtered("main").forEach(t=> listMain.appendChild(renderTaskRow(t)));

    state.tasks
      .filter(t=>t.list==="done")
      .sort((a,b)=>(b.doneAt||0)-(a.doneAt||0))
      .slice(0, 30)
      .forEach(t=> listDone.appendChild(renderDoneRow(t)));

    setupDropZones();
  }

  function renderAll(){
    document.body.classList.toggle("panelOpen", !!state.ui.panelOpen);
    document.body.classList.toggle("focusOnly", !!state.ui.focusOnly);

    selTorionMin.value = String(state.torionMinutes===10?10:5);
    selEnergyFilter.value = state.ui.energyFilter || "tous";
    selSort.value = state.ui.sort || "order";

    renderStats();
    renderFocus();
    renderLists();
    updateUndoRedo();
    setRailActive();
  }

  function setRailActive(){
    // Focus always the primary mode; lists can be hidden on desktop.
    navFocus.classList.add("active");
    navLists.classList.toggle("active", !state.ui.focusOnly);
    navInbox.classList.toggle("active", !state.ui.focusOnly); // same view
  }

  // ---------- Drop zones ----------
  function setupDropZones(){
    [listInbox, listMain].forEach(zone=>{
      zone.addEventListener("dragover", (e)=>{
        e.preventDefault();
        zone.classList.add("dropZone");
        e.dataTransfer.dropEffect="move";
      });
      zone.addEventListener("dragleave", ()=>{
        zone.classList.remove("dropZone");
      });
      zone.addEventListener("drop", (e)=>{
        e.preventDefault();
        zone.classList.remove("dropZone");
        const id = e.dataTransfer.getData("text/plain");
        const t = getTask(id);
        if(!t) return;

        pushHistory();
        const target = (zone === listInbox) ? "inbox" : "main";
        t.list = target;
        t.order = nextOrder(target);
        t.updatedAt = now();
        save();
        renderAll();
      });
    });
  }

  // ---------- Presets ----------
  function presetPrev(){
    const idx = state.presets.findIndex(p=>p.id===state.activePresetId);
    const next = (idx<=0) ? state.presets.length-1 : idx-1;
    state.activePresetId = state.presets[next].id;
    save();
    setPresetLabel();
    showToast(state.presets[next].name);
  }
  function presetNext(){
    const idx = state.presets.findIndex(p=>p.id===state.activePresetId);
    const next = (idx>=state.presets.length-1) ? 0 : idx+1;
    state.activePresetId = state.presets[next].id;
    save();
    setPresetLabel();
    showToast(state.presets[next].name);
  }
  function presetAdd(){
    const name = prompt("Nom", "Nouveau");
    if(!name) return;
    pushHistory();
    const id = "p_"+uid();
    const base = activePreset().defaults;
    state.presets.push({ id, name: name.trim().slice(0,24), defaults:{...base} });
    state.activePresetId = id;
    save();
    renderAll();
    showToast("OK");
  }
  function presetEdit(){
    const p = activePreset();
    const name = prompt("Nom", p.name);
    if(name===null) return;

    const context = prompt("Contexte", p.defaults.context);
    if(context===null) return;

    const category = prompt("Catégorie", p.defaults.category);
    if(category===null) return;

    const tor = prompt("Torions", String(p.defaults.torions));
    if(tor===null) return;

    const pr = prompt("Priorité (1-3)", String(p.defaults.priority));
    if(pr===null) return;

    const en = prompt("Énergie (faible/moyen/haut)", p.defaults.energy);
    if(en===null) return;

    pushHistory();
    p.name = name.trim().slice(0,24) || p.name;
    p.defaults.context = (context.trim() || p.defaults.context);
    p.defaults.category = (category.trim() || p.defaults.category);
    p.defaults.torions = clamp(parseInt(tor,10)||p.defaults.torions, 1, 50);
    p.defaults.priority = clamp(parseInt(pr,10)||p.defaults.priority, 1, 3);
    p.defaults.energy = (["faible","moyen","haut"].includes((en||"").trim()) ? en.trim() : p.defaults.energy);
    save();
    renderAll();
    showToast("OK");
  }
  function presetDel(){
    if(state.presets.length<=1){ showToast("Non."); return; }
    if(!confirm("Supprimer preset ?")) return;
    pushHistory();
    const id = state.activePresetId;
    state.presets = state.presets.filter(p=>p.id!==id);
    state.activePresetId = state.presets[0].id;
    save();
    renderAll();
    showToast("OK");
  }

  // ---------- Export/Import ----------
  function exportJson(){
    const payload = structuredClone(state);
    payload.history = { undo:[], redo:[] };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "eliminator.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    showToast("Export.");
  }

  function importJson(){
    const input = document.createElement("input");
    input.type="file";
    input.accept="application/json";
    input.onchange = async ()=>{
      const f = input.files && input.files[0];
      if(!f) return;
      try{
        const txt = await f.text();
        const obj = JSON.parse(txt);
        if(!obj || !Array.isArray(obj.tasks) || !Array.isArray(obj.presets)){
          showToast("JSON?");
          return;
        }
        pushHistory();
        state = { ...obj, history: state.history };
        save();
        renderAll();
        showToast("Import.");
      }catch{
        showToast("JSON?");
      }
    };
    input.click();
  }

  function resetAll(){
    if(!confirm("Reset ?")) return;
    state = makeInitial();
    save();
    renderAll();
    showToast("OK");
  }

  // ---------- UI Wiring ----------
  // Focus by default on load
  function ensureFocusOnStart(){
    // If no focus task, pick one; else keep.
    if(state.focus.taskId && getTask(state.focus.taskId)) return;
    const t = chooseWeightedTask();
    if(t) setFocus(t.id);
  }

  function roulette(){
    const t = chooseWeightedTask();
    if(!t){
      setFocus(null);
      showToast("Vide.");
      return;
    }
    setFocus(t.id);
    confetti(0.8);
    showToast("Choisi.");
  }

  // Rail actions
  navPanel.addEventListener("click", ()=>{
    state.ui.panelOpen = !state.ui.panelOpen;
    save();
    renderAll();
  });

  navLists.addEventListener("click", ()=>{
    state.ui.focusOnly = false;
    save();
    renderAll();
  });

  navInbox.addEventListener("click", ()=>{
    state.ui.focusOnly = false;
    save();
    renderAll();
    taInbox.focus();
  });

  navFocus.addEventListener("click", ()=>{
    state.ui.focusOnly = true;
    save();
    renderAll();
  });

  navPresetPrev.addEventListener("click", presetPrev);
  navPresetNext.addEventListener("click", presetNext);

  navUndo.addEventListener("click", undo);
  navRedo.addEventListener("click", redo);

  navExport.addEventListener("click", exportJson);
  navImport.addEventListener("click", importJson);

  // Panel controls
  selTorionMin.addEventListener("change", ()=>{
    pushHistory();
    state.torionMinutes = (Number(selTorionMin.value)===10) ? 10 : 5;
    save();
    renderAll();
    showToast("OK");
  });

  selEnergyFilter.addEventListener("change", ()=>{
    state.ui.energyFilter = selEnergyFilter.value;
    save();
    renderAll();
  });

  selSort.addEventListener("change", ()=>{
    state.ui.sort = selSort.value;
    save();
    renderAll();
  });

  btnPresetAdd.addEventListener("click", presetAdd);
  btnPresetEdit.addEventListener("click", presetEdit);
  btnPresetDel.addEventListener("click", presetDel);

  btnUndo.addEventListener("click", undo);
  btnRedo.addEventListener("click", redo);

  btnExport.addEventListener("click", exportJson);
  btnImport.addEventListener("click", importJson);
  btnReset.addEventListener("click", resetAll);

  // Inbox
  btnAdd.addEventListener("click", addTasksFromInbox);

  // Focus buttons
  const rouletteHandler = ()=> roulette();
  btnRoulette.addEventListener("click", rouletteHandler);
  btnRouletteMobile.addEventListener("click", rouletteHandler);

  const degoHandler = ()=> degoOneTorion();
  btnDego.addEventListener("click", degoHandler);
  btnDegoMobile.addEventListener("click", degoHandler);

  btnDone.addEventListener("click", ()=>{
    const t = getTask(state.focus.taskId);
    if(!t) return;
    finishTask(t.id);
  });

  btnSkip.addEventListener("click", ()=>{
    roulette();
  });

  btnTimer.addEventListener("click", ()=>{
    const t = getTask(state.focus.taskId);
    if(!t) return;
    if(state.focus.running) pauseTimer();
    else startTimer();
  });

  // Keyboard shortcuts
  window.addEventListener("keydown", (e)=>{
    const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
    const inField = (tag==="textarea" || tag==="input" || tag==="select");

    // Add inbox: Ctrl/⌘ + Enter
    if(inField && tag==="textarea" && (e.ctrlKey||e.metaKey) && e.key==="Enter"){
      e.preventDefault();
      addTasksFromInbox();
      return;
    }

    // Undo/Redo
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==="z" && !e.shiftKey){
      e.preventDefault(); undo(); return;
    }
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==="z" && e.shiftKey){
      e.preventDefault(); redo(); return;
    }

    if(inField) return;

    // Focus keys
    if(e.key.toLowerCase()==="f"){
      e.preventDefault();
      state.ui.focusOnly = true;
      save();
      renderAll();
      return;
    }
    if(e.key.toLowerCase()==="r"){
      e.preventDefault(); roulette(); return;
    }
    if(e.key.toLowerCase()==="d"){
      e.preventDefault(); degoOneTorion(); return;
    }
    if(e.key==="Escape"){
      // escape toggles lists on desktop
      state.ui.focusOnly = !state.ui.focusOnly;
      save();
      renderAll();
      return;
    }

    // Presets
    if(e.altKey && e.key==="ArrowLeft"){ e.preventDefault(); presetPrev(); return; }
    if(e.altKey && e.key==="ArrowRight"){ e.preventDefault(); presetNext(); return; }
  });

  // Swipe on rail/logo area to switch presets (simple)
  let sx=null, st=null;
  document.querySelector(".logo").addEventListener("pointerdown",(e)=>{ sx=e.clientX; st=Date.now(); });
  document.querySelector(".logo").addEventListener("pointerup",(e)=>{
    if(sx===null) return;
    const dx=e.clientX-sx;
    const dt=Date.now()-st;
    sx=null; st=null;
    if(dt>500) return;
    if(Math.abs(dx)<60) return;
    if(dx<0) presetNext(); else presetPrev();
  });

  // ---------- Drop zones initial attach ----------
  setupDropZones();

  // ---------- Init ----------
  // Normalize lists: "main" is the triaged list name
  // (older states might use "triage")
  state.tasks.forEach(t=>{
    if(t.list==="triage") t.list="main";
    if(!t.list) t.list="inbox";
  });
  state.torionMinutes = (state.torionMinutes===10) ? 10 : 5;
  state.ui.panelOpen = !!state.ui.panelOpen;

  ensureFocusOnStart();
  renderAll();

  // ---------- Utilities for options ----------
  function escapeAttr(s){
    return escapeHtml(s).replace(/"/g,"&quot;");
  }
  function opt(current, options){
    return options.map(v=>{
      const sel = String(v)===String(current) ? "selected" : "";
      return `<option value="${escapeAttr(v)}" ${sel}>${escapeHtml(v)}</option>`;
    }).join("");
  }
})();
</script>
</body>
</html>
